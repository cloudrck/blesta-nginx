 server {
        listen   443 ssl spdy; ## listen for ipv4, nginx 1.8 stable (spdy)
        #listen  443 ssl http2; ## listen for ipv4, nginx 1.9+ mainline (http2)
        
        #listen   [::]:80 default ipv6only=on; ## listen for ipv6

        root /srv/www/clientarea.blesta/public_html;
	 index index.php index.html;
	 error_log /srv/www/clientarea.blesta/logs/clientarea.blesta.error.log warn;

        # Make site accessible from http://localhost/
        server_name clientarea.blesta;
        
        #If you use letsencrypt ssl
        ssl_certificate /etc/letsencrypt/live/clientarea.blesta/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/clientarea.blesta/privkey.pem;
	    ssl_trusted_certificate /etc/letsencrypt/live/clientarea.blesta/chain.pem;

	    ssl_session_cache shared:SSL:20m;
	    ssl_session_timeout 10m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';

	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
	client_body_buffer_size 32m;
	
location ~ \.php$ {
        try_files $uri =404;
        #get from https://github.com/cloudrck/blesta-nginx/blob/master/sites-available/blestav3 

        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_connect_timeout 60;
        fastcgi_send_timeout 180;
        fastcgi_read_timeout 180;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k; #
        fastcgi_busy_buffers_size 256k; 
        fastcgi_temp_file_write_size 256k;
        fastcgi_intercept_errors on;

        #https://github.com/cloudrck/blesta-nginx/blob/master/sites-available/blestav3 done

        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires max;
                log_not_found off;
        }
	
	location ~ (\.pdt) {
    return 403;
    }

location / {
  error_page     404 = @blesta; #IF file doesn't exist
  log_not_found  off;
# For access to install file  
if ($request_uri ~ "^(.*)/install.php$"){
    rewrite install.php /%1/install/ redirect;
  }
}

#Core rewrite
location @blesta {
  rewrite ^(.*)$ /index.php last; 
}

## How to remove /index.php/ in blesta URL:
# Edit lib/init.php, change:
# define("HTACCESS", file_exists(ROOTWEBDIR . ".htaccess"));
# To:
# define("HTACCESS", true);
## from http://docs.blesta.com/display/user/Installing+Blesta#InstallingBlesta-SystemConfiguration

}

server {
    listen 80;
    server_name clientarea.blesta;
    rewrite ^ https://clientarea.blestarequest_uri permanent; #always redirect to use SSL
}
